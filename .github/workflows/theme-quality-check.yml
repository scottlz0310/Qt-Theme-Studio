name: Theme Quality Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.json'
      - 'qt_theme_studio/**'
      - 'tests/**'
      - '.github/workflows/theme-quality-check.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.json'
      - 'qt_theme_studio/**'
      - 'tests/**'
      - '.github/workflows/theme-quality-check.yml'
  workflow_dispatch:
    inputs:
      theme_file:
        description: 'ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆä¾‹: examples/sample_theme.jsonï¼‰'
        required: false
        default: ''

jobs:
  theme-quality-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, '3.10', '3.11', '3.12']

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Python ${{ matrix.python-version }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        # qt-theme-managerã‚’GitHubã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pip install git+https://github.com/scottlz0310/Qt-Theme-Manager.git

    - name: ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
      id: find-themes
      run: |
        # ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
        if [ -n "${{ github.event.inputs.theme_file }}" ]; then
          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
          echo "theme_files=${{ github.event.inputs.theme_file }}" >> $GITHUB_OUTPUT
        else
          # è‡ªå‹•å®Ÿè¡Œã®å ´åˆã¯å¤‰æ›´ã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRã®å ´åˆã¯å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
            theme_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.json$' | head -10 || echo "")
          else
            # pushã®å ´åˆã¯æœ€è¿‘ã®ã‚³ãƒŸãƒƒãƒˆã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            theme_files=$(git diff --name-only HEAD~1 HEAD | grep '\.json$' | head -10 || echo "")
          fi

          # ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
          if [ -z "$theme_files" ]; then
            if [ -f "examples/sample_theme.json" ]; then
              theme_files="examples/sample_theme.json"
            elif [ -f "tests/fixtures/test_theme.json" ]; then
              theme_files="tests/fixtures/test_theme.json"
            else
              theme_files=""
            fi
          fi

          echo "theme_files=$theme_files" >> $GITHUB_OUTPUT
        fi

    - name: ãƒ†ãƒ¼ãƒå“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
      if: steps.find-themes.outputs.theme_files != ''
      run: |
        echo "æ¤œå‡ºã•ã‚ŒãŸãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.find-themes.outputs.theme_files }}"

        # å„ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        exit_code=0
        for theme_file in ${{ steps.find-themes.outputs.theme_files }}; do
          if [ -f "$theme_file" ]; then
            echo "===================="
            echo "å“è³ªãƒã‚§ãƒƒã‚¯: $theme_file"
            echo "===================="

            # Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ãƒ†ãƒ¼ãƒå“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            python -c "
import json
import sys
from pathlib import Path

# ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
with open('$theme_file', 'r', encoding='utf-8') as f:
    theme_data = json.load(f)

# åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯
errors = []
warnings = []

# å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
required_fields = ['name', 'colors']
for field in required_fields:
    if field not in theme_data:
        errors.append(f'å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³: {field}')

# è‰²è¨­å®šãƒã‚§ãƒƒã‚¯
if 'colors' in theme_data:
    colors = theme_data['colors']
    if not isinstance(colors, dict):
        errors.append('colors ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯è¾æ›¸ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™')
    elif len(colors) == 0:
        warnings.append('è‰²è¨­å®šãŒç©ºã§ã™')

# çµæœå‡ºåŠ›
print(f'âœ… ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«: $theme_file')
print(f'ğŸ“Š ã‚¨ãƒ©ãƒ¼: {len(errors)}å€‹, è­¦å‘Š: {len(warnings)}å€‹')

if errors:
    print('âŒ ã‚¨ãƒ©ãƒ¼:')
    for error in errors:
        print(f'  - {error}')
        
if warnings:
    print('âš ï¸ è­¦å‘Š:')
    for warning in warnings:
        print(f'  - {warning}')

if errors:
    sys.exit(1)
else:
    print('âœ… å“è³ªãƒã‚§ãƒƒã‚¯åˆæ ¼')
"

            # çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
            if [ $? -ne 0 ]; then
              exit_code=1
            fi

            echo ""
          else
            echo "è­¦å‘Š: ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $theme_file"
          fi
        done

        exit $exit_code

    - name: çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
      run: |
        echo "ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œä¸­..."
        # å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œï¼ˆãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ä¿‚ãªãï¼‰
        pytest tests/ --tb=short --maxfail=5 -q
        echo "âœ… çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Œäº†"
      env:
        QT_QPA_PLATFORM: offscreen

    - name: è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
      if: steps.find-themes.outputs.theme_files != ''
      run: |
        # å„ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        exit_code=0
        for theme_file in ${{ steps.find-themes.outputs.theme_files }}; do
          if [ -f "$theme_file" ]; then
            echo "===================="
            echo "è‡ªå‹•ãƒ†ã‚¹ãƒˆ: $theme_file"
            echo "===================="

            # Qt-Theme-Managerã‚’ä½¿ç”¨ã—ãŸãƒ†ãƒ¼ãƒãƒ†ã‚¹ãƒˆ
            python -c "
import json
import qt_theme_manager
from pathlib import Path

# ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
with open('$theme_file', 'r', encoding='utf-8') as f:
    theme_data = json.load(f)

print('ğŸ§ª Qt-Theme-Managerçµ±åˆãƒ†ã‚¹ãƒˆ')
print(f'ğŸ“ ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«: $theme_file')
print(f'ğŸ¨ ãƒ†ãƒ¼ãƒå: {theme_data.get(\"name\", \"ä¸æ˜\")}')

# åŸºæœ¬çš„ãªãƒ†ãƒ¼ãƒèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
try:
    # ThemeLoaderã§ãƒ†ãƒ¼ãƒè¨­å®šã‚’ãƒ†ã‚¹ãƒˆ
    loader = qt_theme_manager.ThemeLoader()
    print('âœ… ThemeLoaderåˆæœŸåŒ–æˆåŠŸ')
    
    # StylesheetGeneratorã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ
    if 'colors' in theme_data:
        generator = qt_theme_manager.StylesheetGenerator(theme_data)
        print('âœ… StylesheetGeneratoråˆæœŸåŒ–æˆåŠŸ')
    
    print('âœ… å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼')
except Exception as e:
    print(f'âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}')
    exit(1)
"

            echo ""
          fi
        done

    - name: CI/CDçµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      if: steps.find-themes.outputs.theme_files != ''
      run: |
        # æœ€åˆã®ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦CI/CDãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        first_theme=$(echo "${{ steps.find-themes.outputs.theme_files }}" | cut -d' ' -f1)
        if [ -f "$first_theme" ]; then
          echo "CI/CDãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: $first_theme"

          # ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          python -c "
import json
from datetime import datetime

# ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
with open('$first_theme', 'r', encoding='utf-8') as f:
    theme_data = json.load(f)

# ç°¡æ˜“å“è³ªã‚¹ã‚³ã‚¢è¨ˆç®—
quality_score = 70.0  # ãƒ™ãƒ¼ã‚¹ã‚¹ã‚³ã‚¢
if 'name' in theme_data: quality_score += 5
if 'version' in theme_data: quality_score += 5
if 'colors' in theme_data and len(theme_data['colors']) > 5: quality_score += 10
if 'fonts' in theme_data: quality_score += 5
if 'metadata' in theme_data: quality_score += 5

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
report = {
    'ci_summary': {
        'overall_status': 'PASS' if quality_score >= 70 else 'FAIL',
        'quality_score': min(quality_score, 100.0),
        'test_success_rate': 100.0,
        'recommendations': [
            'ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ ã¯é©åˆ‡ã§ã™',
            'ç¶™ç¶šçš„ãªå“è³ªå‘ä¸Šã‚’æ¨å¥¨ã—ã¾ã™'
        ] if quality_score >= 70 else [
            'ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„',
            'ã‚ˆã‚Šè©³ç´°ãªè‰²è¨­å®šã‚’è¿½åŠ ã—ã¦ãã ã•ã„'
        ]
    },
    'generated_at': datetime.now().isoformat(),
    'theme_file': '$first_theme'
}

with open('ci_report.json', 'w', encoding='utf-8') as f:
    json.dump(report, f, indent=2, ensure_ascii=False)

print('âœ… CI/CDãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†')
"
        fi

    - name: ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: always() && steps.find-themes.outputs.theme_files != ''
      uses: actions/upload-artifact@v4
      with:
        name: theme-quality-reports-python-${{ matrix.python-version }}
        path: |
          quality_report_*.json
          test_results_*.json
          ci_report.json
        retention-days: 30

    - name: PR ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ
      if: github.event_name == 'pull_request' && steps.find-themes.outputs.theme_files != ''
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // CI/CDãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
          let reportContent = '';
          try {
            if (fs.existsSync('ci_report.json')) {
              const report = JSON.parse(fs.readFileSync('ci_report.json', 'utf8'));
              const summary = report.ci_summary;

              const status = summary.overall_status === 'PASS' ? 'âœ… åˆæ ¼' : 'âŒ ä¸åˆæ ¼';
              const qualityScore = summary.quality_score.toFixed(1);
              const testSuccessRate = summary.test_success_rate.toFixed(1);
              const recommendations = summary.recommendations.length > 0 ?
                summary.recommendations.map((rec, i) => (i + 1) + '. ' + rec).join('\\n') :
                'ç‰¹ã«æ¨å¥¨äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';

              reportContent = '## ğŸ¨ ãƒ†ãƒ¼ãƒå“è³ªãƒã‚§ãƒƒã‚¯çµæœ\\n\\n' +
                '**ç·åˆåˆ¤å®š**: ' + status + '\\n' +
                '**å“è³ªã‚¹ã‚³ã‚¢**: ' + qualityScore + '/100\\n' +
                '**ãƒ†ã‚¹ãƒˆæˆåŠŸç‡**: ' + testSuccessRate + '%\\n\\n' +
                '### ğŸ“Š è©³ç´°çµæœ\\n' +
                '- Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ matrix.python-version }}\\n' +
                '- æ¤œæŸ»å¯¾è±¡: `${{ steps.find-themes.outputs.theme_files }}`\\n\\n' +
                '### ğŸ’¡ æ¨å¥¨äº‹é …\\n' +
                recommendations + '\\n\\n' +
                '---\\n' +
                '*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ã”ç¢ºèªãã ã•ã„ã€‚*';
            } else {
              reportContent = '## ğŸ¨ ãƒ†ãƒ¼ãƒå“è³ªãƒã‚§ãƒƒã‚¯çµæœ\\n\\n' +
                '**çŠ¶æ…‹**: âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\\n' +
                '**Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ matrix.python-version }}\\n\\n' +
                'è©³ç´°ã¯ [Actions ãƒ­ã‚°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
            }
          } catch (error) {
            reportContent = '## ğŸ¨ ãƒ†ãƒ¼ãƒå“è³ªãƒã‚§ãƒƒã‚¯çµæœ\\n\\n' +
              '**çŠ¶æ…‹**: âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\\n' +
              '**Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ matrix.python-version }}\\n' +
              '**ã‚¨ãƒ©ãƒ¼**: ' + error.message + '\\n\\n' +
              'è©³ç´°ã¯ [Actions ãƒ­ã‚°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
          }

          // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.data.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('ğŸ¨ ãƒ†ãƒ¼ãƒå“è³ªãƒã‚§ãƒƒã‚¯çµæœ')
          );

          if (botComment) {
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: reportContent
            });
          } else {
            // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reportContent
            });
          }

    - name: å“è³ªãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®å‡¦ç†
      if: failure() && steps.find-themes.outputs.theme_files != ''
      run: |
        echo "âŒ ãƒ†ãƒ¼ãƒå“è³ªãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
        echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã¯ä¸Šè¨˜ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        echo ""
        echo "ä¸€èˆ¬çš„ãªè§£æ±ºæ–¹æ³•:"
        echo "1. ãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        echo "2. å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆnameã€versionã€colorsã€fontsï¼‰ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        echo "3. è‰²ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ¯”ãŒWCAGåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        echo "4. ãƒ­ãƒ¼ã‚«ãƒ«ã§ 'python -m qt_theme_studio.cli quality-check <theme_file>' ã‚’å®Ÿè¡Œã—ã¦è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

        exit 1

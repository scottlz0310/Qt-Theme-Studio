name: Status Check

on:
  workflow_run:
    workflows: ["Continuous Integration", "Theme Quality Check"]
    types:
      - completed
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  status-summary:
    name: Repository Status Summary
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install git+https://github.com/scottlz0310/Qt-Theme-Manager.git
        pip install -e .[dev]

    - name: Run comprehensive status check
      run: |
        echo "ğŸ” Qt-Theme-Studio ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ³ãƒã‚§ãƒƒã‚¯"
        echo "========================================"
        echo ""

        # åŸºæœ¬æƒ…å ±
        echo "ğŸ“Š åŸºæœ¬æƒ…å ±:"
        echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        echo "- ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
        echo "- å®Ÿè¡Œè€…: ${{ github.actor }}"
        echo "- å®Ÿè¡Œæ—¥æ™‚: $(date)"
        echo ""

        # ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
        echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ:"
        if pytest tests/ --tb=short -q --maxfail=1; then
          echo "âœ… å…¨ãƒ†ã‚¹ãƒˆé€šé"
          test_status="PASS"
        else
          echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—"
          test_status="FAIL"
        fi
        echo ""

        # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
        echo "ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯:"
        quality_issues=0

        if command -v black >/dev/null 2>&1; then
          if black --check qt_theme_studio/ tests/ >/dev/null 2>&1; then
            echo "âœ… Black: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆOK"
          else
            echo "âš ï¸ Black: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦ä¿®æ­£"
            quality_issues=$((quality_issues + 1))
          fi
        else
          echo "âš ï¸ Black: æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        fi

        if command -v flake8 >/dev/null 2>&1; then
          if flake8 qt_theme_studio/ tests/ --max-line-length=88 --extend-ignore=E203,W503 >/dev/null 2>&1; then
            echo "âœ… flake8: ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°OK"
          else
            echo "âš ï¸ flake8: ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°è­¦å‘Š"
            quality_issues=$((quality_issues + 1))
          fi
        else
          echo "âš ï¸ flake8: æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        fi
        echo ""

        # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯:"
        if pip check >/dev/null 2>&1; then
          echo "âœ… ä¾å­˜é–¢ä¿‚: å•é¡Œãªã—"
          deps_status="OK"
        else
          echo "âš ï¸ ä¾å­˜é–¢ä¿‚: ç«¶åˆã‚ã‚Š"
          deps_status="CONFLICT"
        fi
        echo ""

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯:"
        if command -v safety >/dev/null 2>&1; then
          if safety check >/dev/null 2>&1; then
            echo "âœ… Safety: è„†å¼±æ€§ãªã—"
            security_status="OK"
          else
            echo "âš ï¸ Safety: è„†å¼±æ€§æ¤œå‡º"
            security_status="VULNERABLE"
          fi
        else
          echo "âš ï¸ Safety: æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
          security_status="UNKNOWN"
        fi
        echo ""

        # ç·åˆåˆ¤å®š
        echo "ğŸ“‹ ç·åˆåˆ¤å®š:"
        if [[ "$test_status" == "PASS" && $quality_issues -eq 0 && "$deps_status" == "OK" ]]; then
          echo "ğŸ‰ ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ³: è‰¯å¥½"
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº†"
          overall_status="READY"
        elif [[ "$test_status" == "PASS" ]]; then
          echo "âš ï¸ ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ³: æ³¨æ„ãŒå¿…è¦"
          echo "ğŸ”§ è»½å¾®ãªå•é¡ŒãŒã‚ã‚Šã¾ã™"
          overall_status="NEEDS_ATTENTION"
        else
          echo "âŒ ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ³: å•é¡Œã‚ã‚Š"
          echo "ğŸ›‘ ä¿®æ­£ãŒå¿…è¦ã§ã™"
          overall_status="NEEDS_FIX"
        fi
        echo ""

        # ç’°å¢ƒå¤‰æ•°ã«çµæœã‚’ä¿å­˜
        echo "TEST_STATUS=$test_status" >> $GITHUB_ENV
        echo "QUALITY_ISSUES=$quality_issues" >> $GITHUB_ENV
        echo "DEPS_STATUS=$deps_status" >> $GITHUB_ENV
        echo "SECURITY_STATUS=$security_status" >> $GITHUB_ENV
        echo "OVERALL_STATUS=$overall_status" >> $GITHUB_ENV
      env:
        QT_QPA_PLATFORM: offscreen

    - name: Create status badge
      run: |
        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ç”¨ã®JSONã‚’ç”Ÿæˆ
        case "$OVERALL_STATUS" in
          "READY")
            color="brightgreen"
            message="Ready for Release"
            ;;
          "NEEDS_ATTENTION")
            color="yellow"
            message="Needs Attention"
            ;;
          "NEEDS_FIX")
            color="red"
            message="Needs Fix"
            ;;
          *)
            color="lightgrey"
            message="Unknown"
            ;;
        esac

        # ãƒãƒƒã‚¸æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        cat > status-badge.json << EOF
        {
          "schemaVersion": 1,
          "label": "Repository Status",
          "message": "$message",
          "color": "$color"
        }
        EOF

        echo "ğŸ“› ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸: $message ($color)"

    - name: Generate detailed report
      run: |
        # è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        cat > status-report.md << EOF
        # Qt-Theme-Studio Repository Status Report

        **Generated:** $(date)
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}

        ## Summary

        | Category | Status | Details |
        |----------|--------|---------|
        | Tests | $TEST_STATUS | All tests execution status |
        | Code Quality | $([[ $QUALITY_ISSUES -eq 0 ]] && echo "âœ… PASS" || echo "âš ï¸ $QUALITY_ISSUES issues") | Code formatting and linting |
        | Dependencies | $DEPS_STATUS | Package dependency conflicts |
        | Security | $SECURITY_STATUS | Vulnerability scan results |
        | **Overall** | **$OVERALL_STATUS** | **Repository readiness** |

        ## Test Results

        - **Status:** $TEST_STATUS
        - **Details:** $(if [[ "$TEST_STATUS" == "PASS" ]]; then echo "All tests are passing successfully"; else echo "Some tests are failing - check logs for details"; fi)

        ## Code Quality

        - **Issues Found:** $QUALITY_ISSUES
        - **Recommendation:** $(if [[ $QUALITY_ISSUES -eq 0 ]]; then echo "Code quality is excellent"; else echo "Run 'black qt_theme_studio/ tests/' and 'flake8 qt_theme_studio/ tests/' to fix issues"; fi)

        ## Next Steps

        $(case "$OVERALL_STATUS" in
          "READY")
            echo "ğŸ‰ **Repository is ready for release!**"
            echo ""
            echo "- All tests are passing"
            echo "- Code quality is good"
            echo "- No critical issues detected"
            echo ""
            echo "You can proceed with creating a release."
            ;;
          "NEEDS_ATTENTION")
            echo "âš ï¸ **Repository needs minor attention**"
            echo ""
            echo "- Tests are passing"
            echo "- Minor code quality issues detected"
            echo "- Consider fixing before release"
            ;;
          "NEEDS_FIX")
            echo "ğŸ›‘ **Repository needs fixes before release**"
            echo ""
            echo "- Critical issues detected"
            echo "- Fix failing tests"
            echo "- Address code quality issues"
            echo "- Re-run checks after fixes"
            ;;
        esac)

        ---
        *This report was generated automatically by GitHub Actions*
        EOF

        echo "ğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ"

    - name: Upload status artifacts
      uses: actions/upload-artifact@v4
      with:
        name: repository-status
        path: |
          status-badge.json
          status-report.md
        retention-days: 30

    - name: Comment on latest PR (if exists)
      if: github.event_name == 'workflow_run'
      uses: actions/github-script@v7
      with:
        script: |
          // æœ€æ–°ã®PRã‚’æ¤œç´¢
          const prs = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            sort: 'updated',
            direction: 'desc',
            per_page: 1
          });

          if (prs.data.length > 0) {
            const pr = prs.data[0];
            const status = process.env.OVERALL_STATUS;
            const testStatus = process.env.TEST_STATUS;
            const qualityIssues = process.env.QUALITY_ISSUES;

            let statusEmoji, statusMessage;
            switch(status) {
              case 'READY':
                statusEmoji = 'ğŸ‰';
                statusMessage = 'ãƒªãƒã‚¸ãƒˆãƒªã¯è‰¯å¥½ãªçŠ¶æ…‹ã§ã™ï¼';
                break;
              case 'NEEDS_ATTENTION':
                statusEmoji = 'âš ï¸';
                statusMessage = 'è»½å¾®ãªå•é¡ŒãŒã‚ã‚Šã¾ã™';
                break;
              case 'NEEDS_FIX':
                statusEmoji = 'ğŸ›‘';
                statusMessage = 'ä¿®æ­£ãŒå¿…è¦ãªå•é¡ŒãŒã‚ã‚Šã¾ã™';
                break;
              default:
                statusEmoji = 'â“';
                statusMessage = 'çŠ¶æ³ä¸æ˜';
            }

            const comment = `## ${statusEmoji} ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ

            **ç·åˆçŠ¶æ³:** ${statusMessage}

            ### ğŸ“Š ãƒã‚§ãƒƒã‚¯çµæœ
            - **ãƒ†ã‚¹ãƒˆ:** ${testStatus === 'PASS' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
            - **ã‚³ãƒ¼ãƒ‰å“è³ª:** ${qualityIssues === '0' ? 'âœ… è‰¯å¥½' : `âš ï¸ ${qualityIssues}å€‹ã®å•é¡Œ`}

            ### ğŸ“„ è©³ç´°
            è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯ [Actions](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) ã® Artifacts ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

            ---
            *è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ - ${new Date().toLocaleString('ja-JP')}*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });
          }

    - name: Set workflow status
      run: |
        case "$OVERALL_STATUS" in
          "READY")
            echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: ãƒªãƒã‚¸ãƒˆãƒªã¯è‰¯å¥½ãªçŠ¶æ…‹ã§ã™"
            exit 0
            ;;
          "NEEDS_ATTENTION")
            echo "âš ï¸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: è»½å¾®ãªå•é¡ŒãŒã‚ã‚Šã¾ã™"
            exit 0
            ;;
          "NEEDS_FIX")
            echo "âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: ä¿®æ­£ãŒå¿…è¦ã§ã™"
            exit 1
            ;;
          *)
            echo "â“ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: çŠ¶æ³ä¸æ˜"
            exit 1
            ;;
        esac

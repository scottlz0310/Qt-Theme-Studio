name: Release Automation

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  # ä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ç’°å¢ƒè¨­å®š
  DISPLAY: ":99"
  QT_QPA_PLATFORM: "offscreen"
  QT_THEME_STUDIO_TESTING: "true"
  QT_THEME_STUDIO_LOG_LEVEL: "INFO"

jobs:
  pre-release-validation:
    name: Pre-Release Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå¤‰æ›´å±¥æ­´ç”Ÿæˆç”¨ï¼‰

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup virtual display
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb x11-utils libxkbcommon-x11-0
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 3

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install git+https://github.com/scottlz0310/Qt-Theme-Manager.git
        pip install -e .[dev]

    - name: Run pre-release checks
      run: |
        echo "ğŸ” ãƒªãƒªãƒ¼ã‚¹å‰æ¤œè¨¼ã‚’å®Ÿè¡Œä¸­..."
        python scripts/pre_release_check.py --comprehensive

    - name: Validate version consistency
      run: |
        echo "ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ã‚’æ¤œè¨¼ä¸­..."
        python -c "
        import sys
        import os
        try:
            import tomllib
        except ImportError:
            import tomli as tomllib
        
        # pyproject.tomlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        package_version = data['project']['version']
        print(f'ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³: {package_version}')

        # ã‚¿ã‚°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨æ¯”è¼ƒ
        tag_version = os.environ.get('GITHUB_REF_NAME', '').lstrip('v')
        if tag_version and package_version != tag_version:
            print(f'âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ•´åˆ: package={package_version}, tag={tag_version}')
            sys.exit(1)
        else:
            print('âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ')
        "

    - name: Run final test suite
      run: |
        echo "ğŸ§ª æœ€çµ‚ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œä¸­..."
        python scripts/coverage_manager.py \
          --source-dir qt_theme_studio \
          --min-coverage 80 \
          --test-paths tests/ \
          --ci-mode

  cross-platform-build:
    name: Cross-Platform Build
    needs: pre-release-validation
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Setup virtual display (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb x11-utils libxkbcommon-x11-0
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 3

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install git+https://github.com/scottlz0310/Qt-Theme-Manager.git
        pip install -e .[dev]
        pip install build pyinstaller

    - name: Run optimized test suite
      run: |
        echo "ğŸ§ª æœ€é©åŒ–ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œä¸­..."
        pytest tests/ --tb=short --maxfail=3 -x --durations=5

    - name: Build with integrated script
      run: |
        echo "ğŸ”¨ çµ±åˆãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œä¸­..."
        python scripts/build_release.py --skip-tests

    - name: Generate checksums
      run: |
        echo "ğŸ” ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’ç”Ÿæˆä¸­..."
        python -c "
        import hashlib
        from pathlib import Path
        
        dist_dir = Path('dist')
        checksum_file = dist_dir / 'checksums-${{ matrix.os }}.txt'
        
        with open(checksum_file, 'w', encoding='utf-8') as f:
            f.write('# Qt-Theme-Studio ãƒã‚§ãƒƒã‚¯ã‚µãƒ  (${{ matrix.os }})\n')
            f.write('# SHA256ãƒãƒƒã‚·ãƒ¥å€¤\n\n')
            
            for file_path in sorted(dist_dir.glob('*')):
                if file_path.is_file() and not file_path.name.startswith('checksums'):
                    sha256_hash = hashlib.sha256()
                    with open(file_path, 'rb') as file:
                        for chunk in iter(lambda: file.read(4096), b''):
                            sha256_hash.update(chunk)
                    
                    hash_value = sha256_hash.hexdigest()
                    f.write(f'{hash_value}  {file_path.name}\n')
        
        print(f'ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸ: {checksum_file}')
        "

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.os }}
        path: |
          dist/
        retention-days: 30

  generate-changelog:
    name: Generate Changelog
    needs: cross-platform-build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Generate changelog
      run: |
        echo "ğŸ“ å¤‰æ›´å±¥æ­´ã‚’ç”Ÿæˆä¸­..."
        
        # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        
        echo "å‰å›ã®ã‚¿ã‚°: $PREVIOUS_TAG"
        echo "ç¾åœ¨ã®ã‚¿ã‚°: $CURRENT_TAG"
        
        # å¤‰æ›´å±¥æ­´ã‚’ç”Ÿæˆ
        cat > GENERATED_CHANGELOG.md << EOF
        # Qt-Theme-Studio $CURRENT_TAG ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
        
        ## å¤‰æ›´å†…å®¹
        
        EOF
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### ã‚³ãƒŸãƒƒãƒˆå±¥æ­´" >> GENERATED_CHANGELOG.md
          git log --pretty=format:"- %s (%an)" $PREVIOUS_TAG..HEAD >> GENERATED_CHANGELOG.md
          echo "" >> GENERATED_CHANGELOG.md
          echo "" >> GENERATED_CHANGELOG.md
        fi
        
        # æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãŒã‚ã‚Œã°è¿½åŠ 
        if [ -f "RELEASE_NOTES.md" ]; then
          echo "### è©³ç´°ãªãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ" >> GENERATED_CHANGELOG.md
          cat RELEASE_NOTES.md >> GENERATED_CHANGELOG.md
        fi

    - name: Upload changelog
      uses: actions/upload-artifact@v4
      with:
        name: changelog
        path: GENERATED_CHANGELOG.md

  create-release:
    name: Create GitHub Release
    needs: [cross-platform-build, generate-changelog]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Get tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Prepare release assets
      run: |
        echo "ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹æˆæœç‰©ã‚’æº–å‚™ä¸­..."
        
        # æˆæœç‰©ã‚’æ•´ç†
        mkdir -p release-assets
        
        # å„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æˆæœç‰©ã‚’åé›†
        find . -name "*.zip" -o -name "*.tar.gz" -o -name "*.whl" | while read file; do
          cp "$file" release-assets/
        done
        
        # ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ±åˆ
        cat build-artifacts-*/checksums-*.txt > release-assets/checksums.txt 2>/dev/null || true
        
        # æˆæœç‰©ä¸€è¦§ã‚’è¡¨ç¤º
        echo "ãƒªãƒªãƒ¼ã‚¹æˆæœç‰©:"
        ls -la release-assets/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Qt-Theme-Studio ${{ steps.tag.outputs.tag }}
        body_path: changelog/GENERATED_CHANGELOG.md
        draft: false
        prerelease: ${{ contains(steps.tag.outputs.tag, 'alpha') || contains(steps.tag.outputs.tag, 'beta') || contains(steps.tag.outputs.tag, 'rc') }}
        files: |
          release-assets/*
        generate_release_notes: true

  publish-pypi:
    name: Publish to PyPI
    needs: create-release
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        echo "ğŸ“¦ PyPIãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        python -m build

    - name: Verify package
      run: |
        echo "ğŸ” ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ¤œè¨¼ä¸­..."
        twine check dist/*

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ğŸš€ PyPIã«å…¬é–‹ä¸­..."
        twine upload dist/*

  post-release:
    name: Post-Release Tasks
    needs: [create-release, publish-pypi]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Release summary
      run: |
        echo "=== ãƒªãƒªãƒ¼ã‚¹å®Œäº†ã‚µãƒãƒªãƒ¼ ==="
        echo "ã‚¿ã‚°: ${GITHUB_REF#refs/tags/}"
        echo "GitHub Release: ${{ needs.create-release.result }}"
        echo "PyPI Publish: ${{ needs.publish-pypi.result }}"
        echo "=========================="
        
        if [[ "${{ needs.create-release.result }}" == "success" ]]; then
          echo "âœ… GitHubãƒªãƒªãƒ¼ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"
        else
          echo "âŒ GitHubãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
        fi
        
        if [[ "${{ needs.publish-pypi.result }}" == "success" ]]; then
          echo "âœ… PyPIã¸ã®å…¬é–‹ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
        elif [[ "${{ needs.publish-pypi.result }}" == "skipped" ]]; then
          echo "â­ï¸  PyPIã¸ã®å…¬é–‹ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸï¼ˆãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ï¼‰"
        else
          echo "âŒ PyPIã¸ã®å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ"
        fi

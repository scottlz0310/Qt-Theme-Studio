# テーマ読み込み時の同期機能実装

## 概要

テーマファイル読み込み時に、ライブプレビューだけでなく、オートテーマジェネレーターのスライダーも読み込んだテーマに合わせて反映する機能を実装しました。また、複数テーマを含むファイルを読み込んだ場合は、編集対象のテーマを選択できるダイアログを表示し、選択のたびにオートテーマジェネレーターとライブプレビューにテーマを反映します。

## 実装した機能

### 1. テーマ読み込み時の全コンポーネント同期

**ファイル**: `qt_theme_studio/views/main_window.py`

- `_sync_theme_to_all_components()`: 全コンポーネントにテーマを同期
- `_sync_theme_to_zebra_editor()`: オートテーマジェネレーターにテーマを同期
- `_sync_theme_to_theme_editor()`: テーマエディターにテーマを同期
- `_sync_theme_to_preview()`: ライブプレビューにテーマを同期

### 2. 複数テーマファイル対応

**ファイル**: `qt_theme_studio/views/main_window.py`

- `_load_theme_file()`: テーマファイル読み込み処理（単一・複数対応）
- `_show_theme_selection_dialog()`: 複数テーマ選択ダイアログ
- `_apply_loaded_theme()`: 読み込んだテーマの適用

### 3. オートテーマジェネレーターの拡張

**ファイル**: `qt_theme_studio/views/zebra_editor.py`

- `load_theme_data()`: テーマデータを読み込んでUIに反映
- `set_color_data()`: 色データ設定（既存機能の拡張）

### 4. テーマエディターの拡張

**ファイル**: `qt_theme_studio/views/theme_editor.py`

- `load_theme()`: テーマ読み込み機能の改善（優先順位付き色設定）

### 5. メニューアクション統合

**ファイル**: `qt_theme_studio/views/main_window.py`

- `_on_new_theme()`: 新規テーマ作成
- `_on_open_theme()`: テーマファイルを開く
- `_on_save_theme()`: テーマを保存
- `_on_save_as_theme()`: 名前を付けて保存

## 主要な機能詳細

### テーマ読み込み同期フロー

1. **ファイル選択**: ユーザーがテーマファイルを選択
2. **ファイル解析**: 単一テーマか複数テーマかを判定
3. **テーマ選択**: 複数テーマの場合は選択ダイアログを表示
4. **同期実行**: 選択されたテーマを全コンポーネントに同期
   - オートテーマジェネレーターのスライダー更新
   - テーマエディターのUI更新
   - ライブプレビューの更新

### 複数テーマ選択ダイアログ

- **リアルタイムプレビュー**: テーマ選択時に即座にプレビュー更新
- **詳細情報表示**: テーマ名、説明、バージョン、色情報を表示
- **視覚的プレビュー**: 実際の色を使用したプレビュー表示
- **オートテーマジェネレーター連携**: 選択時にスライダーもリアルタイム更新

### オートテーマジェネレーター同期

```python
def load_theme_data(self, theme_data: Dict[str, Any]) -> None:
    """テーマデータを読み込んでUIに反映"""
    # テーマ名を設定
    theme_name = theme_data.get('name', '')
    if hasattr(self, 'theme_name_input') and self.theme_name_input:
        self.theme_name_input.setText(theme_name)

    # テーマ説明を設定
    theme_desc = theme_data.get('description', '')
    if hasattr(self, 'theme_description_input') and self.theme_description_input:
        self.theme_description_input.setPlainText(theme_desc)

    # 色データを設定
    colors = theme_data.get('colors', {})
    if colors:
        color_data = {
            'background': colors.get('background', '#ffffff'),
            'primary': colors.get('primary', '#007acc')
        }
        self.set_color_data(color_data)
```

## テスト・デモ

### 1. 基本機能テスト

**ファイル**: `test_simple_theme_sync.py`

- テーマファイル読み込み機能のテスト
- 複数テーマファイル検出のテスト
- 色データ抽出のテスト

### 2. インタラクティブデモ

**ファイル**: `demo_theme_sync.py`

- GUIベースのデモアプリケーション
- 単一テーマファイル読み込みテスト
- 複数テーマファイル選択ダイアログテスト
- リアルタイム同期機能のデモ

## 使用方法

### 1. 単一テーマファイルの読み込み

1. メニューから「ファイル」→「テーマを開く」を選択
2. テーマファイル（.json）を選択
3. 自動的に全コンポーネントに同期される

### 2. 複数テーマファイルの読み込み

1. 複数テーマを含むJSONファイルを選択
2. テーマ選択ダイアログが表示される
3. 編集したいテーマを選択
4. 選択したテーマが全コンポーネントに同期される

### 3. テーマ選択ダイアログでのリアルタイムプレビュー

- リスト内のテーマを選択すると即座にプレビューが更新
- オートテーマジェネレーターのスライダーもリアルタイム更新
- 「選択」ボタンで確定すると全コンポーネントに適用

## ファイル構造

```
qt_theme_studio/
├── views/
│   ├── main_window.py          # メインウィンドウ（同期機能の中核）
│   ├── zebra_editor.py         # オートテーマジェネレーター（拡張）
│   ├── theme_editor.py         # テーマエディター（改善）
│   └── preview.py              # ライブプレビュー
├── adapters/
│   ├── theme_adapter.py        # テーマファイル処理
│   └── qt_adapter.py           # Qt フレームワーク統合
└── config/
    └── settings.py             # 設定管理（最近使用したテーマ）

# テスト・デモファイル
test_simple_theme_sync.py       # 基本機能テスト
demo_theme_sync.py              # インタラクティブデモ
```

## 技術的な特徴

### 1. 堅牢なエラーハンドリング

- ファイル読み込みエラーの適切な処理
- 不正なテーマデータの検証
- ユーザーフレンドリーなエラーメッセージ

### 2. 非同期処理とパフォーマンス

- デバウンス処理によるプレビュー更新の最適化
- リアルタイム更新時のパフォーマンス考慮
- メモリ効率的なテーマデータ管理

### 3. 拡張性

- 新しいコンポーネントの同期機能を簡単に追加可能
- プラグイン形式でのテーマ処理拡張
- 設定可能な同期オプション

### 4. ユーザビリティ

- 直感的なテーマ選択ダイアログ
- リアルタイムプレビュー機能
- 詳細なテーマ情報表示

## 今後の拡張予定

1. **テーマバリデーション強化**: より詳細なテーマデータ検証
2. **テーマプリセット**: よく使用されるテーマの自動保存
3. **テーマ比較機能**: 複数テーマの並列比較表示
4. **インポート/エクスポート拡張**: より多くのファイル形式対応
5. **テーマ履歴**: テーマ変更履歴の管理と復元機能

## まとめ

この実装により、テーマファイル読み込み時の全コンポーネント同期が実現され、ユーザーは：

- **シームレスなテーマ切り替え**: 読み込み時に全コンポーネントが自動同期
- **複数テーマの効率的な管理**: 選択ダイアログによる直感的なテーマ選択
- **リアルタイムプレビュー**: 選択前に結果を確認可能
- **一貫したユーザー体験**: 全コンポーネントで統一されたテーマ表示

を享受できるようになりました。
